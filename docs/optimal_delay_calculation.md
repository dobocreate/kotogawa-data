# 最適遅延時間の算出方法

## 概要
このドキュメントでは、河川水位とダム放流量間の最適遅延時間を算出する方法について詳細に説明します。最適遅延時間は、相互相関分析（Cross-Correlation Analysis）を用いて計算されます。

## 基本原理

### 相互相関分析とは
相互相関分析は、2つの時系列データ間の時間的な関係性を定量化する統計的手法です。本システムでは、ダム放流量の変化が河川水位に与える影響の時間的遅延を測定するために使用します。

### 数学的定義
2つの時系列 x(t) と y(t) の相互相関関数は以下で定義されます：

```
R_xy(τ) = E[(x(t) - μ_x)(y(t+τ) - μ_y)] / (σ_x * σ_y)
```

ここで：
- τ: 遅延時間（ラグ）
- μ_x, μ_y: それぞれの時系列の平均値
- σ_x, σ_y: それぞれの時系列の標準偏差
- E[]: 期待値

## 実装手順

### 1. データ前処理
```python
# 欠損値の除去
valid_mask = df['ダム_全放流量'].notna() & df['水位'].notna()
discharge_clean = df.loc[valid_mask, 'ダム_全放流量'].values
water_level_clean = df.loc[valid_mask, '水位'].values
```

### 2. 全体的な最適遅延時間の計算

#### 遅延範囲の設定
- 遅延時間範囲: 0分～300分（0～30ステップ、10分間隔）
- 各ステップで相互相関係数を計算

#### 相関計算のアルゴリズム
```python
lags = range(0, 31)  # 0-30ステップ（0-300分）
correlations = []

for lag in lags:
    if lag == 0:
        # 遅延なし
        corr = np.corrcoef(discharge_clean, water_level_clean)[0, 1]
    else:
        # 遅延あり：放流量をlag分前にシフト
        corr = np.corrcoef(discharge_clean[:-lag], water_level_clean[lag:])[0, 1]
    
    correlations.append(corr)
```

#### 最適遅延の決定
```python
max_corr_idx = np.argmax(correlations)
optimal_lag = lags[max_corr_idx]
optimal_delay_minutes = optimal_lag * 10
```

### 3. 放流量レベル別の最適遅延時間

#### レベル分割
放流量を100 m³/s刻みで分割：
- 0-100 m³/s
- 100-200 m³/s
- ...
- 1100-1200 m³/s

#### 動的閾値の適用
```python
dynamic_threshold = 5  # 最小データ数
```

各レベルで5個以上のデータポイントがある場合のみ分析を実行します。

#### レベル別相関計算
```python
for min_q, max_q in discharge_levels:
    mask_level = (discharge_clean >= min_q) & (discharge_clean < max_q)
    data_count = mask_level.sum()
    
    if data_count >= dynamic_threshold:
        discharge_level = discharge_clean[mask_level]
        water_level_level = water_level_clean[mask_level]
        
        # 最大相関の遅延を計算
        best_lag = 0
        best_corr = 0
        for lag in range(0, 31):
            if lag > 0 and len(discharge_level) > lag:
                corr = np.corrcoef(discharge_level[:-lag], water_level_level[lag:])[0, 1]
                if not np.isnan(corr) and corr > best_corr:
                    best_corr = corr
                    best_lag = lag
```

## 結果の解釈

### 相関係数の意味
- **正の相関**: 放流量増加が水位上昇に寄与
- **負の相関**: 放流量増加が水位低下に寄与（一般的でない）
- **相関係数の大きさ**: 0.3以上で中程度、0.5以上で強い相関

### 遅延時間の物理的意味
遅延時間は以下の要因によって決まります：
1. **河川の流下時間**: ダムから観測地点までの距離と流速
2. **河道特性**: 河川の勾配、断面形状、粗度
3. **流量規模**: 大流量時は高速流により遅延時間が短縮
4. **河床変動**: 土砂堆積や洗掘による流下特性の変化

### 放流量レベル別の違い
- **低放流量レベル**: 平常時の流況、河道内流下が主体
- **中放流量レベル**: 洪水初期段階、河道の流下能力範囲内
- **高放流量レベル**: 洪水ピーク時、河道満杯または氾濫状態

## 品質管理

### データ品質チェック
1. **欠損値の処理**: 連続する時系列データが必要
2. **異常値の検出**: 統計的手法による外れ値の特定
3. **時刻同期**: データの時刻が正確に同期されている必要

### 信頼性の評価指標
1. **相関係数の大きさ**: |r| ≥ 0.3を目安とする
2. **データ数**: 統計的有意性のため最低5個のデータポイント
3. **物理的妥当性**: 計算された遅延時間が物理的に合理的か

## 制限事項と注意点

### システムの制限
1. **線形相関の仮定**: 非線形関係は捉えられない
2. **定常性の仮定**: 時間とともに関係が変化する場合は不適切
3. **因果関係**: 相関は因果関係を意味しない

### 解釈上の注意
1. **複合的要因**: 降雨、他の支川からの流入等の影響
2. **季節性**: 植生や河床状態の季節変化
3. **極値の影響**: 異常洪水時のデータが全体に与える影響

## 応用と改善案

### 高度化の方向性
1. **非線形モデル**: 機械学習手法の適用
2. **多変量解析**: 降雨量等の他の要因を含む分析
3. **時変モデル**: 時間とともに変化する関係の捉捉
4. **物理モデル**: 水理学的知見を組み込んだモデル

### 実用上の活用
1. **洪水予警報**: リアルタイムでの水位予測
2. **ダム操作支援**: 効果的な放流操作の計画
3. **河川管理**: 河道整備効果の定量評価
4. **防災計画**: 避難判断の基準時間設定

## 参考資料

### 統計的手法
- 時系列解析の基礎理論
- 相互相関分析の数学的背景
- 信号処理における遅延推定

### 水文学的知見
- 河川流況の物理学
- ダム操作と下流影響
- 洪水流の特性