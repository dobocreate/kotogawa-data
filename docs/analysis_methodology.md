# 河川水位遅延時間分析手法

## 1. 分析アプローチ

### 1.1 スライディングウィンドウ方式

本分析では、放流量と水位の時系列データに対してスライディングウィンドウ方式を採用しています。

**手法の詳細**:
- **ウィンドウサイズ**: ±1時間（前後1時間の計2時間）
- **サンプリング間隔**: 1時間ごと
- **遅延時間範囲**: 0～180分を1分刻みで探索

**処理フロー**:
1. 各時点を中心とした2時間のウィンドウを設定
2. ウィンドウ内のデータで相互相関を計算
3. 最大相関を示す遅延時間を特定
4. 1時間後にウィンドウを移動し、繰り返し

### 1.2 相互相関分析

相互相関関数を用いて、放流量の変化が水位に反映されるまでの時間差を計算：

```
R(τ) = Σ[(Q(t) - Q̄)(H(t+τ) - H̄)] / [σ_Q × σ_H × N]
```

ここで：
- R(τ): 遅延時間τでの相関係数
- Q(t): 時刻tの放流量
- H(t+τ): 時刻t+τの水位
- Q̄, H̄: それぞれの平均値
- σ_Q, σ_H: それぞれの標準偏差
- N: データ数

### 1.3 期間分類

データを以下の3つのカテゴリに分類：

1. **安定期間** (変動係数 < 0.05)
   - pre_stable: 変動期間前の安定期
   - post_stable: 変動期間後の安定期
   - low_activity: 独立した低活動期

2. **準変動期間** (0.05 ≤ 変動係数 < 0.15)
   - 中程度の変動を示す期間

3. **変動期間** (変動係数 ≥ 0.15)
   - 大きな変動を示す期間

## 2. ピーク・ボトム対応分析

### 2.1 ピーク・ボトム検出

`scipy.signal.find_peaks`を使用して極値を検出：

**ピーク検出条件**:
- prominence: データ範囲の10%以上
- distance: 30分以上の間隔
- height: 3m以上（水位）、150m³/s以上（放流量）

### 2.2 対応付けアルゴリズム

1. 放流量のピーク/ボトムを基準として設定
2. 60分以内の水位ピーク/ボトムを候補として抽出
3. 時間的に最も近いものを対応付け
4. 遅延時間と値の関係を分析

## 3. ヒステリシス分析

### 3.1 変化率の計算

```
dQ/dt = (Q(t+1) - Q(t-1)) / (2 × Δt)
dH/dt = (H(t+1) - H(t-1)) / (2 × Δt)
```

### 3.2 上昇期・下降期の分類

- **上昇期**: dQ/dt > 0
- **下降期**: dQ/dt < 0
- **安定期**: |dQ/dt| ≤ 閾値

### 3.3 応答特性の比較

上昇期と下降期で異なる応答率を計算し、ヒステリシス効果を定量化。

## 4. 変化量関係分析

### 4.1 変化量の計算

各時点での変化量を計算：
```
ΔQ = Q(t) - Q(t-delay)
ΔH = H(t) - H(t-delay)
```

ここで、delayは推定された遅延時間。

### 4.2 線形回帰分析

増加期と減少期それぞれで線形回帰を実施：
```
ΔH = α × ΔQ + β
```

### 4.3 放流量レンジ別分析

放流量を以下のレンジに分割して分析：
- 150-300 m³/s
- 300-500 m³/s
- 500 m³/s以上

## 5. 予測モデルの構築

### 5.1 適応型ハイブリッドモデル

状態に応じて予測手法を切り替え：

1. **安定状態**: 単純な線形モデル
2. **準変動状態**: 動的遅延時間を考慮
3. **変動状態**: ピーク・ボトム追跡

### 5.2 動的遅延時間

```python
delay = base_delay × direction_factor × level_factor
```

- base_delay: 放流量レンジ別の基準遅延
- direction_factor: 増加時0.9、減少時1.1
- level_factor: 水位レベルによる補正

### 5.3 オンライン学習

予測誤差に基づいてパラメータを調整：
```python
correction_factor = 1.0 + learning_rate × mean_error
```

## 6. 検証手法

### 6.1 時系列交差検証

- 24時間の検証期間を設定
- 2時間の履歴データで初期化
- 3時間ごとに予測を実行
- 実測値との比較

### 6.2 評価指標

- **MAE (Mean Absolute Error)**: 平均絶対誤差
- **RMSE (Root Mean Square Error)**: 二乗平均平方根誤差
- **10cm以内率**: 誤差が10cm以内の割合
- **相関係数**: 予測値と実測値の相関

### 6.3 リードタイム別評価

30分、60分、90分、120分、180分の各リードタイムで個別に評価を実施。