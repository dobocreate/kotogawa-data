# 水位予測・放流量予測アルゴリズムの開発

## 1. データ分析による知見の発見

### 1.1 降雨と放流量の関係性分析

#### 1.1.1 時間遅延の発見
2023年7月1日の豪雨イベントを含む過去データを分析した結果、以下の重要な発見がありました：

**観測された現象**：
- 降雨のピークと放流量のピークには明確な時間差が存在
- この遅延は一定ではなく、ダムの運用状態により変動

**具体的なデータ例**：
- 2023年6月30日23:30：降雨が1→11→21→29 mm/hと急増
- 同時刻：放流量も369→370→377→399 m³/sと即座に反応開始
- 一方、降雨ピーク後も放流量は約2時間増加を継続

**分析結果による遅延パターン**：
- **増加開始時**：0分（降雨急増に即座に反応）
- **増加継続中**：120分（慣性的な継続）
- **減少時**：60分（中間的な遅延）

#### 1.1.2 放流量変化の特性
**変化速度の非対称性**：
- 増加時の最大速度：+36.5 m³/s/10min
- 減少時の最大速度：-24.3 m³/s/10min（増加速度の約89%）
- この差はダムの物理的特性と安全運用の制約を反映

**状態遷移の観察**：
- 放流量の変化は連続的ではなく、明確な「状態」を持つ
- 増加中、定常、減少中の3つの状態が存在
- 状態間の遷移には一定の条件が必要

### 1.2 水位変動の要因分析

#### 1.2.1 相関分析の結果
各要因と水位変動の相関係数を計算：

**放流量の影響**：
- 現在の放流量：相関係数 0.75
- 60分前の放流量変化：相関係数 0.62
- 120分前の放流量変化：相関係数 0.48

**降雨の影響**：
- 瞬間降雨量：相関係数 0.45
- 3時間累積雨量：相関係数 0.68
- 6時間累積雨量：相関係数 0.72
→ 累積雨量の方が瞬間値より重要

**水位の自己相関**：
- 10分前の水位：相関係数 0.95以上
- 強い自己相関性は時系列予測の有効性を示唆

#### 1.2.2 時間スケールの理解
物理現象の時間スケール：
- **降雨→放流量**：0～120分の遅延
- **放流量→水位**：即座～60分の影響
- **降雨→水位**：30分～180分の複合的影響

### 1.3 予測における課題の発見

#### 1.3.1 初期モデルの問題点
**低降雨時の過剰反応**：
- 2023年6月30日22:00の事例
- 降雨1-2 mm/hでも放流量が増加し続ける予測
- 実際は50分間で-7.4 m³/sの減少

**状態判定の不適切さ**：
- 当初の状態判定しきい値：50 m³/s/30分
- 実際の運用では10 m³/s程度の変化も重要
- 細かな変化を見逃し、不適切な予測につながる

## 2. 知見を活かしたアルゴリズムの構築

### 2.1 放流量予測アルゴリズム

#### 2.1.1 状態ベースモデルの採用
データ分析で発見した3つの状態を明確にモデル化：

**状態の定義**：
- **増加中（+1）**：過去30分で10 m³/s以上増加
- **定常（0）**：変化が±10 m³/s未満
- **減少中（-1）**：過去30分で10 m³/s以上減少

しきい値10 m³/sは、実際の運用変化を適切に捉える値として設定。

#### 2.1.2 動的遅延時間の実装
分析で発見した遅延パターンを組み込み：

```
遅延時間の決定ロジック：
- IF 降雨急増（10分先が現在+5mm/h以上）AND 非増加状態
  → 遅延0分（即座に反応）
- ELIF 増加継続中
  → 遅延120分（慣性的継続）
- ELIF 低降雨（<10mm/h）AND 非増加状態
  → 遅延60分（減少開始）
- ELSE
  → 遅延120分（標準）
```

#### 2.1.3 降雨強度別の変化率
データ分析から得られた実際の変化速度を反映：

**高降雨時（≥20 mm/h）**：
- 基本変化率：+36.5 m³/s/10min

**中降雨時（10-20 mm/h）**：
- 基本変化率：+29.1 m³/s/10min

**低降雨時（<10 mm/h）**：
- 減少中の場合：-24.3 m³/s/10min
- 増加中で降雨<5 mm/h：-12.2 m³/s/10min（減少に転換）
- 増加中で降雨5-10 mm/h：0（現状維持）

#### 2.1.4 状態更新ロジック
低降雨継続時の状態遷移を実装：
- 3ステップ（30分）連続で低降雨→増加状態を定常へ
- さらに低降雨継続→定常から減少へ

### 2.2 水位予測アルゴリズム

#### 2.2.1 特徴量の選定
相関分析の結果に基づいて重要な特徴量を選定：

**採用した特徴量**：
1. 累積雨量（3時間、6時間）- 高相関
2. 放流量（現在、変化量）- 最重要因子
3. 過去水位（10分、20分、30分前）- 自己相関
4. 気象データ（湿度、気圧、気温、風速）- 補助的

#### 2.2.2 予測モデルの選択
**Random Forestを採用した理由**：
- 非線形性への対応（単純な線形モデルでは不十分）
- 特徴量の重要度を評価可能
- 過学習への耐性

**モデル構成**：
- 決定木数：100（計算時間と精度のバランス）
- 最大深さ：20（過学習の抑制）
- 10分間隔の反復予測（データ記録間隔に合わせる）

### 2.3 統合システムの設計

#### 2.3.1 予測フローの構築
1. **降雨予測の取得**（1時間先まで）
2. **放流量予測**（3時間先まで）
3. **水位予測**（予測放流量を使用）

#### 2.3.2 実用性を考慮した制約
**1時間降雨予測の制限**：
- 実際のAPIの精度限界を想定
- 1時間以降は最終予測値を継続使用

**3時間予測期間**：
- 防災対応に必要な時間
- 精度と実用性のバランス

## 3. アルゴリズムの検証と改善

### 3.1 検証結果

#### 3.1.1 改善前の問題
- 2023年6月30日22:00：低降雨でも増加予測
- 2023年7月1日00:00：初期反応の遅れ

#### 3.1.2 改善後の効果
- 低降雨時の適切な減少予測
- 降雨急増時の即座の反応（遅延0分）
- 実際の運用パターンとの高い一致

### 3.2 最終的な改良

#### 3.2.1 10分先予測への変更
**変更理由**：
- 30分先では不確実性が高い
- 10分先によりconservativeな判断
- 誤った急変動の抑制

**効果**：
- より安定した予測
- 実運用により適した挙動

## 4. まとめ

### 4.1 データ分析の重要性
- 物理現象の時間スケールの理解
- 実運用パターンの発見
- 非線形性の存在確認

### 4.2 構築されたアルゴリズムの特徴
- 状態ベースの放流量予測
- 動的な遅延時間
- 機械学習による水位予測
- 実用性を重視した設計

### 4.3 今後の展望
- より長期間のデータ蓄積
- 深層学習モデルの導入検討
- リアルタイム更新システムの構築